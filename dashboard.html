<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MaliPay Dashboard</title>

<style>
body {
  margin: 0;
  font-family: "Segoe UI", sans-serif;
  color: #111;
}

/* ğŸ¥ VIDEO BACKGROUND */
#bg-video {
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  z-index: -2;
  filter: brightness(0.75) saturate(1.4);
}

/* ğŸŸ  ORANGE OVERLAY */
body::before {
  content: "";
  position: fixed;
  inset: 0;
  background: linear-gradient(135deg, rgba(255,140,0,0.35), rgba(255,80,0,0.25));
  z-index: -1;
}

/* ğŸ§Š GLASS CARD */
.dashboard-box {
  width: 400px;
  margin: 40px auto;
  padding: 25px;
  border-radius: 22px;
  background: rgba(255,255,255,0.92);
  backdrop-filter: blur(16px);
  box-shadow: 0 15px 35px rgba(0,0,0,0.3);
  animation: fadeUp 0.7s ease;
}

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(25px); }
  to { opacity: 1; transform: translateY(0); }
}

.user-card {
  background: rgba(255,255,255,0.95);
  padding: 12px;
  margin-top: 10px;
  border-radius: 14px;
}

button {
  width: 100%;
  padding: 12px;
  margin-top: 12px;
  border-radius: 14px;
  border: none;
  font-weight: bold;
  cursor: pointer;
  background: linear-gradient(45deg,#ff9a00,#ff6a00);
  color: white;
}

button:disabled {
  opacity: 0.5;
}

input, textarea {
  width: 100%;
  padding: 12px;
  margin-top: 10px;
  border-radius: 12px;
  border: 1px solid #ccc;
  background: white;
}
</style>
</head>

<body>

<video autoplay muted loop id="bg-video">
  <source src="bg.mp4" type="video/mp4">
</video>

<header style="text-align:center;padding:15px;font-size:26px;font-weight:bold;color:#ff9a00;">
ğŸ’ MaliPay â€” Dashboard
</header>

<main>
<section class="dashboard-box">

<h2 id="welcome"></h2>

<p>ğŸ’° Solde actuel</p>
<p id="solde" style="font-size:28px;font-weight:bold;color:#ff9a00;"></p>

<button onclick="logout()" style="background:crimson;">ğŸšª DÃ©connexion</button>

<hr>

<!-- ğŸ”” NOTIFICATIONS -->
<h3 onclick="toggleNotifications()" style="cursor:pointer;">
ğŸ“© Notifications (<span id="notifCount">0</span>)
</h3>
<div id="notifBox" style="display:none;"></div>

<hr>

<!-- ğŸ” PASSWORD -->
<h3 onclick="togglePassword()" style="cursor:pointer;">
ğŸ” Changer mot de passe
</h3>
<div id="passwordBox" style="display:none;">
<input id="oldPass" type="password" placeholder="Ancien mot de passe">
<input id="newPass" type="password" placeholder="Nouveau mot de passe">
<button onclick="changePassword()">Modifier</button>
<p id="passMsg"></p>
</div>

<hr>

<!-- ğŸ’¸ TRANSFERT -->
<h3 onclick="toggleTransfer()" style="cursor:pointer;">
ğŸ’¸ Envoyer de l'argent
</h3>

<div id="transferBox" style="display:none;">
<input id="receiver" placeholder="NumÃ©ro destinataire">
<input id="amount" type="number" placeholder="Montant FCFA">
<textarea id="reason" placeholder="Raison (facultatif)"></textarea>

<label>ğŸ“… Programmer transfert (optionnel)</label>
<input id="scheduleDate" type="datetime-local">

<button id="sendBtn" onclick="sendMoney()">Envoyer</button>
<p id="message"></p>
</div>

</section>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getDatabase, ref, get, update, push, remove } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD3XGP0vqqCwKftSvn1M72N_O0lxtIjzFc",
  authDomain: "ma-money-2841e.firebaseapp.com",
  databaseURL: "https://ma-money-2841e-default-rtdb.firebaseio.com",
  projectId: "ma-money-2841e"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let currentUser = JSON.parse(localStorage.getItem("loggedUser"));
if(!currentUser) window.location.href = "login.html";

const welcome = document.getElementById("welcome");
const soldeBox = document.getElementById("solde");
const messageBox = document.getElementById("message");
const notifBox = document.getElementById("notifBox");
const notifCount = document.getElementById("notifCount");
const sendBtn = document.getElementById("sendBtn");

welcome.innerText = "ğŸ‘‹ Bienvenue " + currentUser.name;

// ğŸ”„ SOLDE
async function loadBalance(){
  const snap = await get(ref(db, "users/" + currentUser.phone));
  currentUser = snap.val();
  localStorage.setItem("loggedUser", JSON.stringify(currentUser));
  soldeBox.innerText = currentUser.solde + " FCFA";
}
loadBalance();

// ğŸ”” NOTIFS
async function loadNotifications(){
  const snap = await get(ref(db, "notifications/" + currentUser.phone));
  notifBox.innerHTML = "";
  let count = 0;

  if(snap.exists()){
    Object.entries(snap.val()).reverse().forEach(([id, n])=>{
      count++;
      notifBox.innerHTML += `
      <div class="user-card">
        <strong>${n.title}</strong><br>
        ğŸ“± ${n.phone}<br>
        ğŸ’° ${n.amount} FCFA<br>
        ğŸ•’ ${n.date}<br>
        ğŸ“ ${n.reason || "Aucune raison"}
        ${n.claimable ? `<button onclick="sendClaim('${n.txId}')" style="background:red;">ğŸš¨ RÃ©clamation</button>` : ""}
        <button onclick="deleteNotif('${id}')" style="background:crimson;">ğŸ—‘ Supprimer</button>
      </div>`;
    });
  }
  notifCount.innerText = count;
}
loadNotifications();

// ğŸ—‘ DELETE NOTIF
window.deleteNotif = async function(id){
  await remove(ref(db, "notifications/" + currentUser.phone + "/" + id));
  loadNotifications();
};

// ğŸš¨ CLAIM
window.sendClaim = async function(txId){
  const txSnap = await get(ref(db,"history/" + txId));
  if(!txSnap.exists()) return alert("Transaction introuvable");

  let tx = txSnap.val();
  let receiverSnap = await get(ref(db,"users/" + tx.to));
  if(!receiverSnap.exists()) return alert("Destinataire introuvable");

  let receiverData = receiverSnap.val();
  if(receiverData.solde < tx.amount){
    alert("âŒ Solde destinataire insuffisant");
    return;
  }

  await push(ref(db,"claims"), {
    phone: currentUser.phone,
    transactionId: txId,
    message: "Demande d'annulation transaction",
    date: new Date().toLocaleString()
  });

  alert("âœ… RÃ©clamation envoyÃ©e !");
};

// ğŸ” PASSWORD
window.changePassword = async function(){
  const oldPassVal = document.getElementById("oldPass").value;
  const newPassVal = document.getElementById("newPass").value;
  const passMsg = document.getElementById("passMsg");

  if(oldPassVal !== currentUser.password){
    passMsg.innerText = "âŒ Ancien mot de passe incorrect";
    return;
  }

  if(newPassVal.length < 4){
    passMsg.innerText = "âŒ Mot de passe trop court";
    return;
  }

  currentUser.password = newPassVal;
  await update(ref(db, "users/" + currentUser.phone), currentUser);
  passMsg.innerText = "âœ… Mot de passe modifiÃ©";
};

// ğŸ’¸ TRANSFERT FIXÃ‰
window.sendMoney = async function(){
  if(sendBtn.disabled) return;

  sendBtn.disabled = true;
  sendBtn.innerText = "â³ Traitement...";

  try {
    const receiverPhone = document.getElementById("receiver").value.trim();
    const amount = parseFloat(document.getElementById("amount").value);
    const reason = document.getElementById("reason").value.trim();
    const scheduleDate = document.getElementById("scheduleDate").value;

    if(!receiverPhone || amount <= 0){
      messageBox.innerText = "âŒ DonnÃ©es invalides";
      resetButton();
      return;
    }

    const senderSnap = await get(ref(db,"users/" + currentUser.phone));
    const receiverSnap = await get(ref(db,"users/" + receiverPhone));
    const treasurySnap = await get(ref(db,"treasury"));

    if(!senderSnap.exists() || !receiverSnap.exists()){
      messageBox.innerText = "âŒ Compte introuvable";
      resetButton();
      return;
    }

    let sender = senderSnap.val();
    let receiverData = receiverSnap.val();
    let treasury = treasurySnap.exists() ? treasurySnap.val() : { balance:0, rate:0.01 };

    let fee = amount * treasury.rate;
    let total = amount + fee;

    if(sender.solde < total){
      messageBox.innerText = "âŒ Solde insuffisant (montant + frais)";
      resetButton();
      return;
    }

    // PROGRAMMÃ‰
    if(scheduleDate){
      await push(ref(db,"scheduledTransfers"), {
        from: sender.phone,
        to: receiverPhone,
        amount, fee, reason,
        scheduledFor: scheduleDate,
        createdAt: new Date().toLocaleString()
      });

      messageBox.innerText = "ğŸ“… Transfert programmÃ©";
      resetForm();
      resetButton();
      return;
    }

    // IMMÃ‰DIAT
    sender.solde -= total;
    receiverData.solde += amount;
    treasury.balance += fee;

    await update(ref(db,"users/"+sender.phone), sender);
    await update(ref(db,"users/"+receiverPhone), receiverData);
    await update(ref(db,"treasury"), treasury);

    const tx = await push(ref(db,"history"), {
      from: sender.phone,
      to: receiverPhone,
      amount, fee, reason,
      date: new Date().toLocaleString()
    });

    await push(ref(db,"notifications/"+receiverPhone), {
      title: "ğŸ’° Argent reÃ§u",
      phone: sender.phone,
      amount, reason,
      date: new Date().toLocaleString(),
      claimable: false
    });

    await push(ref(db,"notifications/"+sender.phone), {
      title: "ğŸ“¤ Argent envoyÃ©",
      phone: receiverPhone,
      amount, reason,
      date: new Date().toLocaleString(),
      claimable: true,
      txId: tx.key
    });

    messageBox.innerText = "âœ… Transfert rÃ©ussi";
    resetForm();
    loadBalance();
    loadNotifications();

  } catch(e){
    messageBox.innerText = "âŒ Erreur : " + e.message;
  }

  resetButton();
};

// ğŸ§¹ RESET
function resetForm(){
  document.getElementById("receiver").value = "";
  document.getElementById("amount").value = "";
  document.getElementById("reason").value = "";
  document.getElementById("scheduleDate").value = "";
}

function resetButton(){
  sendBtn.disabled = false;
  sendBtn.innerText = "Envoyer";
}

// ğŸ‘ TOGGLES
window.toggleNotifications = () => notifBox.style.display = notifBox.style.display === "none" ? "block" : "none";
window.togglePassword = () => passwordBox.style.display = passwordBox.style.display === "none" ? "block" : "none";
window.toggleTransfer = () => transferBox.style.display = transferBox.style.display === "none" ? "block" : "none";

// ğŸšª LOGOUT
window.logout = function(){
  localStorage.removeItem("loggedUser");
  window.location.href = "login.html";
};
</script>

</body>
</html>

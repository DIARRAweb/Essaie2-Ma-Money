<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Historique ‚Äî MaliPay</title>

<style>
body { margin:0; font-family:Segoe UI; color:#111; }

#bg-video {
  position:fixed; inset:0;
  width:100%; height:100%;
  object-fit:cover;
  z-index:-2;
  filter:brightness(0.85);
}

body::before {
  content:"";
  position:fixed; inset:0;
  background:linear-gradient(135deg, rgba(255,140,0,0.35), rgba(255,90,0,0.25));
  z-index:-1;
}

header { text-align:center; font-size:26px; padding:18px; color:#ff9a00; font-weight:bold; }

.card {
  max-width:1100px;
  margin:18px auto;
  background:rgba(255,255,255,0.9);
  padding:18px;
  border-radius:18px;
  backdrop-filter: blur(18px);
  box-shadow:0 15px 35px rgba(0,0,0,0.35);
}

input {
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid #ccc;
  font-size:16px;
}

table {
  width:100%;
  border-collapse:collapse;
  margin-top:12px;
}

th, td {
  padding:12px;
  border-bottom:1px solid #eee;
  text-align:center;
}

th { background:#fff2e0; color:#ff7a00; }

button {
  padding:10px 14px;
  border-radius:10px;
  border:none;
  background:linear-gradient(45deg,#ff9a00,#ff6a00);
  color:white;
  font-weight:bold;
  cursor:pointer;
}

button:hover { transform:scale(1.05); }

.danger { background:crimson; }

.badge {
  padding:4px 8px;
  border-radius:8px;
  font-size:12px;
  font-weight:bold;
}

.badge-normal { background:#16a34a; color:white; }
.badge-claim { background:crimson; color:white; }
.badge-cancel { background:#64748b; color:white; }

.hidden { display:none; }
</style>
</head>

<body>

<video autoplay muted loop id="bg-video">
<source src="bg-admin.mp4">
</video>

<header>üìú Historique des transactions</header>

<div class="card">
<input id="searchHistory" placeholder="üîé Rechercher par ID">
<button onclick="toggleHistory()">üëÅ Afficher / Masquer historique</button>
<div id="historyList" class="hidden"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getDatabase, ref, get, update, remove, onValue, push } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const app = initializeApp({ databaseURL:"https://ma-money-2841e-default-rtdb.firebaseio.com" });
const db = getDatabase(app);

const historyList = document.getElementById("historyList");
const searchInput = document.getElementById("searchHistory");

let cachedHistory = {};

window.toggleHistory = ()=> historyList.classList.toggle("hidden");

function generateID(date, amount){
  const d = new Date(date || Date.now());
  let day = String(d.getDate()).padStart(2,"0");
  let month = String(d.getMonth()+1).padStart(2,"0");
  let year = d.getFullYear();
  return `${day}.${month}.${year}.${amount}`;
}

onValue(ref(db,"history"), snap=>{
  cachedHistory = snap.val() || {};
  renderHistory();
});

searchInput.addEventListener("input", renderHistory);

async function renderHistory(){
  const search = searchInput.value.trim();
  let rows = "";

  for(const [key,h] of Object.entries(cachedHistory).reverse()){

    let id = h.customID;
    if(!id){
      id = generateID(h.date, h.amount);
      await update(ref(db,"history/"+key), { customID:id });
    }

    if(search && !id.includes(search)) continue;

    let badge = `<span class="badge badge-normal">‚úî Normal</span>`;
    if(h.cancelled) badge = `<span class="badge badge-cancel">‚Ü© Annul√©e</span>`;
    else if(h.claimed) badge = `<span class="badge badge-claim">‚ö† R√©clamation</span>`;

    rows += `
    <tr>
      <td><b>${id}</b></td>
      <td>${h.from}</td>
      <td>‚ûú</td>
      <td>${h.to}</td>
      <td><b>${h.amount} FCFA</b></td>
      <td>${h.date}</td>
      <td>${badge}</td>
      <td>
        <button onclick="cancelTransaction('${key}')">‚Ü© Annuler</button>
        <button onclick="deleteHistory('${key}')" class="danger">üóë</button>
      </td>
    </tr>`;
  }

  historyList.innerHTML = `
  <table>
    <thead>
      <tr>
        <th>ID</th><th>Exp√©diteur</th><th></th><th>Destinataire</th>
        <th>Montant</th><th>Date</th><th>Statut</th><th>Actions</th>
      </tr>
    </thead>
    <tbody>${rows || "<tr><td colspan='8'>Aucun r√©sultat</td></tr>"}</tbody>
  </table>`;
}

window.deleteHistory = async id=>{
  await remove(ref(db,"history/"+id));
};

// ‚úÖ CANCEL + FULL REFUND SAFE
window.cancelTransaction = async historyID=>{
  const snap = await get(ref(db,"history/"+historyID));
  const h = snap.val();
  if(!h) return alert("‚ùå Transaction introuvable");
  if(h.cancelled) return alert("‚ö† D√©j√† annul√©e");

  const senderSnap = await get(ref(db,"users/"+h.from));
  const receiverSnap = await get(ref(db,"users/"+h.to));

  let sender = senderSnap.val();
  let receiver = receiverSnap.val();

  if(!sender || !receiver) return alert("‚ùå Comptes introuvables");
  if(receiver.solde < h.amount) return alert("‚ùå Destinataire ne peut pas rembourser");

  receiver.solde -= h.amount;
  sender.solde += h.amount;

  await update(ref(db,"users/"+h.from), sender);
  await update(ref(db,"users/"+h.to), receiver);

  await update(ref(db,"history/"+historyID), {
    cancelled:true,
    claimed:true,
    refundDone:true,
    status:"Annul√©e"
  });

  await push(ref(db,"notifications/"+h.from), {
    title:"üí∏ Remboursement re√ßu",
    phone:h.to,
    amount:h.amount,
    date:new Date().toLocaleString()
  });

  alert("‚úÖ Transaction annul√©e & argent rembours√© !");
};
</script>
</body>
</html>

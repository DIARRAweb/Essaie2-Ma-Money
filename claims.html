<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>RÃ©clamations â€” MaliPay</title>

<style>
body { margin:0; font-family:Segoe UI; color:#111; }
#bg-video { position:fixed; inset:0; width:100%; height:100%; object-fit:cover; z-index:-2; filter:brightness(0.85); }
body::before { content:""; position:fixed; inset:0; background:linear-gradient(135deg, rgba(255,140,0,0.35), rgba(255,90,0,0.25)); z-index:-1; }

header { text-align:center; font-size:26px; padding:18px; color:#ff9a00; font-weight:bold; }

.card {
  max-width:900px;
  margin:18px auto;
  background:rgba(255,255,255,0.9);
  padding:18px;
  border-radius:18px;
  box-shadow:0 15px 35px rgba(0,0,0,0.35);
}

.user-card {
  background:white;
  padding:14px;
  border-radius:14px;
  margin-top:12px;
}

button {
  width:100%;
  padding:12px;
  border-radius:12px;
  border:none;
  background:linear-gradient(45deg,#ff9a00,#ff6a00);
  color:white;
  margin-top:8px;
  font-weight:bold;
  cursor:pointer;
}
button:hover { transform:scale(1.03); }

.empty { text-align:center; font-weight:bold; color:#64748b; }
</style>
</head>

<body>

<video autoplay muted loop id="bg-video">
<source src="bg-admin.mp4">
</video>

<header>ğŸš¨ RÃ©clamations</header>

<div class="card">
<div id="claimList"></div>
</div>

<div class="card">
<button onclick="location.href='admin.html'">â¬… Retour</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getDatabase, ref, get, update, push } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const app = initializeApp({ databaseURL:"https://ma-money-2841e-default-rtdb.firebaseio.com" });
const db = getDatabase(app);

const claimList = document.getElementById("claimList");

function generateID(date, amount){
  const d = new Date(date || Date.now());
  let day = String(d.getDate()).padStart(2,"0");
  let month = String(d.getMonth()+1).padStart(2,"0");
  let year = d.getFullYear();
  return `${day}.${month}.${year}.${amount}`;
}

async function loadClaims(){
  const claimsSnap = await get(ref(db,"claims"));
  const claims = claimsSnap.val() || {};
  claimList.innerHTML = "";

  let hasClaims = false;

  for(const [claimKey,c] of Object.entries(claims)){
    if(c.resolved) continue;

    const historyKey = c.transactionId || c.historyKey || claimKey;

    const historySnap = await get(ref(db,"history/"+historyKey));
    const h = historySnap.val();
    if(!h) continue;

    hasClaims = true;

    let id = h.customID || generateID(h.date, h.amount);
    if(!h.customID){
      await update(ref(db,"history/"+historyKey), { customID:id });
    }

    claimList.innerHTML += `
    <div class="user-card">
      ğŸ†” Transaction ID : <b>${id}</b><br>
      ğŸ“¤ ExpÃ©diteur : ${h.from}<br>
      ğŸ“¥ Destinataire : ${h.to}<br>
      ğŸ’° Montant : <b>${h.amount} FCFA</b><br>
      ğŸ“± TÃ©lÃ©phone : ${c.phone || "â€”"}<br>
      ğŸ“ Message : ${c.message || "â€”"}<br>
      ğŸ•’ Date : ${c.date || ""}

      <button onclick="resolveClaim('${historyKey}','${claimKey}')">
        âœ” RÃ©soudre & Annuler transaction
      </button>
    </div>`;
  }

  if(!hasClaims){
    claimList.innerHTML = `<div class="empty">âœ… Aucune rÃ©clamation active</div>`;
  }
}

window.resolveClaim = async (historyKey, claimKey) => {

  const historySnap = await get(ref(db,"history/"+historyKey));
  const h = historySnap.val();

  if(!h) return alert("âŒ Transaction introuvable");
  if(h.cancelled) return alert("âš  DÃ©jÃ  annulÃ©e");

  const senderSnap = await get(ref(db,"users/"+h.from));
  const receiverSnap = await get(ref(db,"users/"+h.to));

  let sender = senderSnap.val();
  let receiver = receiverSnap.val();

  if(!sender || !receiver) return alert("âŒ Comptes introuvables");
  if(receiver.solde < h.amount) return alert("âŒ Solde insuffisant");

  receiver.solde -= h.amount;
  sender.solde += h.amount;

  await update(ref(db,"users/"+h.from), sender);
  await update(ref(db,"users/"+h.to), receiver);

  await update(ref(db,"history/"+historyKey), {
    cancelled:true,
    claimed:true,
    refundDone:true,
    status:"AnnulÃ©e aprÃ¨s rÃ©clamation"
  });

  await update(ref(db,"claims/"+claimKey), {
    resolved:true,
    processed:true
  });

  await push(ref(db,"notifications/"+h.from), {
    title:"ğŸ’¸ Transaction annulÃ©e",
    amount:h.amount,
    phone:h.to,
    date:new Date().toLocaleString()
  });

  alert("âœ… Transaction annulÃ©e + remboursement !");
  loadClaims();
};

loadClaims();
</script>

</body>
</html>

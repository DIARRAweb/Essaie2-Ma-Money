<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<header>
<h1>ğŸ›¡ MaliPay â€” Admin</h1>
</header>

<main>
<section class="dashboard-box">

<h3>CrÃ©er utilisateur</h3>
<input id="newName" placeholder="Nom">
<input id="newPhone" placeholder="TÃ©lÃ©phone">
<input id="newPass" placeholder="Mot de passe">
<input id="newSolde" type="number" placeholder="Solde">

<button onclick="addUser()">Ajouter</button>

<hr>

<h3>Gestion</h3>
<input id="targetPhone" placeholder="TÃ©lÃ©phone">
<input id="amount" type="number" placeholder="Montant">

<button onclick="deposit()">DÃ©pÃ´t</button>
<button onclick="withdraw()">Retrait</button>

<hr>

<button onclick="window.location.href='treasury.html'">ğŸ’° TrÃ©sorerie</button>

<hr>

<h3>Utilisateurs</h3>
<div id="userList"></div>

<hr>

<h3>Historique</h3>
<div id="historyList"></div>

<button onclick="logout()">DÃ©connexion</button>

</section>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getDatabase, ref, get, set, update, remove } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD3XGP0vqqCwKftSvn1M72N_O0lxtIjzFc",
  authDomain: "ma-money-2841e.firebaseapp.com",
  databaseURL: "https://ma-money-2841e-default-rtdb.firebaseio.com",
  projectId: "ma-money-2841e",
  storageBucket: "ma-money-2841e.appspot.com",
  messagingSenderId: "725879283734",
  appId: "1:725879283734:web:70130964d6a7f33a335537"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let admin = JSON.parse(localStorage.getItem("loggedUser"));
if(!admin || admin.role !== "admin") window.location.href = "login.html";

async function loadUsers(){
const snap = await get(ref(db,"users"));
userList.innerHTML = "";
Object.values(snap.val() || {}).forEach(u=>{
userList.innerHTML += `
<div class="user-card">
<strong>${u.name}</strong><br>
ğŸ“± ${u.phone}<br>
ğŸ’° ${u.solde} FCFA<br>
${u.frozen ? "â„ GelÃ©" : "Actif"}
<button onclick="toggleFreeze('${u.phone}')">Geler</button>
<button onclick="deleteUser('${u.phone}')">Supprimer</button>
</div>`;
});
}

window.addUser = async function(){
await set(ref(db,"users/"+newPhone.value), {
phone:newPhone.value,
password:newPass.value,
name:newName.value,
solde:parseFloat(newSolde.value)||0,
role:"user",
frozen:false
});
alert("AjoutÃ© !");
loadUsers();
};

window.toggleFreeze = async function(phone){
const snap = await get(ref(db,"users/"+phone));
let user = snap.val();
user.frozen = !user.frozen;
await update(ref(db,"users/"+phone), user);
loadUsers();
};

window.deleteUser = async function(phone){
if(confirm("Supprimer ?")){
await remove(ref(db,"users/"+phone));
loadUsers();
}
};

window.deposit = async function(){
let phone = targetPhone.value;
let amount = parseFloat(document.getElementById("amount").value);
const snap = await get(ref(db,"users/"+phone));
let user = snap.val();
user.solde += amount;
await update(ref(db,"users/"+phone), user);
loadUsers();
};

window.withdraw = async function(){
let phone = targetPhone.value;
let amount = parseFloat(document.getElementById("amount").value);
const snap = await get(ref(db,"users/"+phone));
let user = snap.val();
if(user.solde < amount){ alert("Solde insuffisant"); return; }
user.solde -= amount;
await update(ref(db,"users/"+phone), user);
loadUsers();
};

async function loadHistory(){
const snap = await get(ref(db,"history"));
historyList.innerHTML = "";
Object.values(snap.val() || {}).forEach(h=>{
historyList.innerHTML += `
<div class="user-card">
ğŸ“¤ ${h.from} âœ ğŸ“¥ ${h.to}<br>
ğŸ’° ${h.amount} FCFA | Frais ${h.fee}<br>
ğŸ•’ ${h.date}
</div>`;
});
}

loadUsers();
loadHistory();

window.logout = function(){
localStorage.removeItem("loggedUser");
window.location.href="login.html";
};
</script>

</body>
</html>

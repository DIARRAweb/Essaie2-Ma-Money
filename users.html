<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Admin Utilisateurs ‚Äî MaliPay</title>

<style>
body {
  margin:0;
  font-family:Segoe UI, sans-serif;
  background:#fff7ee;
}

/* HEADER */
header {
  text-align:center;
  padding:18px;
  font-size:26px;
  font-weight:bold;
  color:#ff7a00;
}

/* CARD */
.card {
  max-width:1100px;
  margin:16px auto;
  background:white;
  padding:18px;
  border-radius:14px;
  box-shadow:0 10px 30px rgba(0,0,0,0.1);
}

/* INPUT */
input {
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid #ccc;
  margin-top:8px;
}

/* BUTTON */
button {
  padding:10px;
  border-radius:10px;
  border:none;
  background:linear-gradient(45deg,#ff9a00,#ff6a00);
  color:white;
  font-weight:bold;
  cursor:pointer;
  margin-top:8px;
}
button:hover { transform:scale(1.03); }

.danger { background:crimson; }
.success { background:#16a34a; }
.gray { background:#64748b; }

/* TABLE */
table {
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
th, td {
  padding:10px;
  border-bottom:1px solid #eee;
  text-align:left;
}
th {
  background:#fff2e0;
  color:#ff7a00;
}

.status-active { color:#16a34a; font-weight:bold; }
.status-frozen { color:crimson; font-weight:bold; }

.avatar {
  width:40px;
  height:40px;
  border-radius:50%;
  object-fit:cover;
}

.hidden { display:none; }
</style>
</head>

<body>

<header>üë• MaliPay ‚Äî Gestion Utilisateurs</header>

<!-- SEARCH -->
<div class="card">
  <input id="searchUser" placeholder="üîé Rechercher par num√©ro..." oninput="loadUsers()">
</div>

<!-- ADD USER -->
<div class="card">
  <h3>‚ûï Ajouter un utilisateur</h3>
  <input id="newName" placeholder="Nom complet">
  <input id="newPhone" placeholder="Num√©ro t√©l√©phone">
  <input id="newPass" placeholder="Mot de passe">
  <input id="newSolde" type="number" placeholder="Solde initial">
  <input id="newPhoto" placeholder="URL photo (optionnel)">
  <button onclick="addUser()">Cr√©er utilisateur</button>
  <p id="addMsg"></p>
</div>

<!-- USERS TABLE -->
<div class="card">
  <h3>üìã Liste des utilisateurs</h3>

  <button id="toggleBtn" class="gray" onclick="toggleUserList()">
    üëÅ Afficher la liste
  </button>

  <div id="userBox" class="hidden">
    <table>
      <thead>
        <tr>
          <th>Photo</th>
          <th>Nom</th>
          <th>Num√©ro</th>
          <th>Solde</th>
          <th>Statut</th>
          <th>D√©p√¥t</th>
          <th>Retrait</th>
          <th>S√©curit√©</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="userTable"></tbody>
    </table>
  </div>
</div>

<!-- BACK -->
<div class="card">
  <button onclick="location.href='admin.html'">‚¨Ö Retour</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getDatabase, ref, get, set, update, remove } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const app = initializeApp({ databaseURL:"https://ma-money-2841e-default-rtdb.firebaseio.com" });
const db = getDatabase(app);

const table = document.getElementById("userTable");
const userBox = document.getElementById("userBox");
const toggleBtn = document.getElementById("toggleBtn");

// TOGGLE LIST
window.toggleUserList = ()=>{
  userBox.classList.toggle("hidden");

  if(userBox.classList.contains("hidden")){
    toggleBtn.innerText = "üëÅ Afficher la liste";
  } else {
    toggleBtn.innerText = "üôà Masquer la liste";
  }
};

// LOAD USERS
window.loadUsers = async ()=>{
  const search = document.getElementById("searchUser").value.trim();
  const snap = await get(ref(db,"users"));
  const users = snap.val() || {};

  table.innerHTML = "";

  if(search){
    userBox.classList.remove("hidden");
    toggleBtn.innerText = "üôà Masquer la liste";
  }

  Object.values(users).forEach(u=>{
    if(!u.phone) return;
    if(search && !u.phone.includes(search)) return;

    table.innerHTML += `
      <tr>
        <td><img src="${u.photo || 'https://i.imgur.com/6VBx3io.png'}" class="avatar"></td>
        <td>${u.name || "Sans nom"}</td>
        <td>${u.phone}</td>
        <td>${u.solde ?? 0} FCFA</td>
        <td class="${u.frozen ? "status-frozen" : "status-active"}">
          ${u.frozen ? "Gel√©" : "Actif"}
        </td>

        <td><button onclick="deposit('${u.phone}')">‚ûï</button></td>
        <td><button onclick="withdraw('${u.phone}')">‚ûñ</button></td>

        <td>
          <button onclick="toggleFreeze('${u.phone}')" class="gray">
            ${u.frozen ? "D√©geler" : "Geler"}
          </button>
        </td>

        <td>
          <button onclick="resetPassword('${u.phone}')">üîê</button>
          <button onclick="deleteUser('${u.phone}')" class="danger">üóë</button>
        </td>
      </tr>
    `;
  });
};

// DEPOSIT
window.deposit = async phone=>{
  const amount = parseFloat(prompt("Montant d√©p√¥t :"));
  if(isNaN(amount) || amount <= 0) return;

  const snap = await get(ref(db,"users/"+phone));
  let u = snap.val();

  u.solde = (u.solde || 0) + amount;

  await update(ref(db,"users/"+phone), { solde: u.solde });
  loadUsers();
};

// WITHDRAW SAFE
window.withdraw = async phone=>{
  const amount = parseFloat(prompt("Montant retrait :"));
  if(isNaN(amount) || amount <= 0) return;

  const snap = await get(ref(db,"users/"+phone));
  let u = snap.val();

  if(amount > u.solde){
    alert("‚ùå Solde insuffisant !");
    return;
  }

  u.solde -= amount;

  await update(ref(db,"users/"+phone), { solde: u.solde });
  loadUsers();
};

// FREEZE
window.toggleFreeze = async phone=>{
  const snap = await get(ref(db,"users/"+phone));
  let u = snap.val();

  u.frozen = !u.frozen;

  await update(ref(db,"users/"+phone), { frozen: u.frozen });
  loadUsers();
};

// RESET PASS
window.resetPassword = async phone=>{
  const pass = prompt("Nouveau mot de passe :");
  if(!pass || pass.length < 4) return;

  await update(ref(db,"users/"+phone), { password: pass });
  alert("Mot de passe modifi√©");
};

// DELETE
window.deleteUser = async phone=>{
  if(confirm("Supprimer cet utilisateur ?")){
    await remove(ref(db,"users/"+phone));
    loadUsers();
  }
};

// ADD USER
window.addUser = async ()=>{
  const name = newName.value.trim();
  const phone = newPhone.value.trim();
  const password = newPass.value.trim();
  const solde = parseFloat(newSolde.value);
  const photo = newPhoto.value.trim();
  const msg = addMsg;

  if(!name || !phone || !password || isNaN(solde)){
    msg.innerText = "‚ùå Champs invalides";
    return;
  }

  const exists = await get(ref(db,"users/"+phone));
  if(exists.exists()){
    msg.innerText = "‚ùå Num√©ro d√©j√† utilis√©";
    return;
  }

  await set(ref(db,"users/"+phone), {
    name, phone, password,
    solde,
    photo,
    frozen:false,
    createdAt: new Date().toLocaleString()
  });

  msg.innerText = "‚úÖ Utilisateur ajout√©";
  newName.value = "";
  newPhone.value = "";
  newPass.value = "";
  newSolde.value = "";
  newPhoto.value = "";

  loadUsers();
};

loadUsers();
</script>

</body>
</html>
